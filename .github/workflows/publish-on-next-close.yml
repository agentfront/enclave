name: Publish libs on next/* merge

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  packages: write
  id-token: write

concurrency:
  group: publish-next-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: false

jobs:
  publish:
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'next/') &&
      github.event.pull_request.base.ref == github.event.repository.default_branch
    runs-on: ubuntu-latest
    environment: release
    env:
      NX_DAEMON: "false"

    steps:
      - name: Determine release ref
        id: release_ref
        shell: bash
        env:
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          set -euo pipefail

          if [ -n "${MERGE_SHA:-}" ] && [ "$MERGE_SHA" != "null" ]; then
            REF="$MERGE_SHA"
          else
            REF="$BASE_REF"
          fi

          echo "ref=$REF" >> "$GITHUB_OUTPUT"

      - name: Checkout release commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.release_ref.outputs.ref }}

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          registry-url: "https://registry.npmjs.org/"

      - name: Update npm CLI for trusted publishing
        run: npm install -g npm@latest

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Set Nx SHAs
        uses: nrwl/nx-set-shas@v4

      - name: Find affected publishable libs
        id: to_publish
        shell: bash
        run: |
          set -euo pipefail

          # Get all publishable libs
          ALL_PUBLISHABLE=$(node -e "
          const { execSync } = require('child_process');
          try {
            const out = execSync('npx nx show projects -p tag:scope:publishable --type lib --json', { encoding: 'utf8' });
            const arr = JSON.parse(out);
            process.stdout.write(arr.join(','));
          } catch (e) {
            process.stdout.write('');
          }
          ")

          if [ -z "$ALL_PUBLISHABLE" ]; then
            echo "projects=" >> "$GITHUB_OUTPUT"
            echo "No publishable libraries found"
            exit 0
          fi

          # Get affected libs
          AFFECTED=$(node -e "
          const { execSync } = require('child_process');
          try {
            const out = execSync('npx nx show projects --affected --type lib --json', { encoding: 'utf8' });
            const arr = JSON.parse(out);
            process.stdout.write(arr.join(','));
          } catch (e) {
            process.stdout.write('');
          }
          ")

          if [ -z "$AFFECTED" ]; then
            echo "projects=" >> "$GITHUB_OUTPUT"
            echo "No affected libraries"
            exit 0
          fi

          # Intersection of publishable and affected
          PROJECTS=$(node -e "
          const all = '$ALL_PUBLISHABLE'.split(',').filter(Boolean);
          const affected = '$AFFECTED'.split(',').filter(Boolean);
          const intersection = all.filter(lib => affected.includes(lib));
          process.stdout.write(intersection.join(','));
          ")

          echo "projects=$PROJECTS" >> "$GITHUB_OUTPUT"

          if [ -n "$PROJECTS" ]; then
            echo "Projects to publish: $PROJECTS"
          else
            echo "No projects to publish"
          fi

      - name: Stop if nothing to publish
        if: steps.to_publish.outputs.projects == ''
        run: echo "Nothing to publish."

      - name: Determine release SHA
        id: release_sha
        shell: bash
        env:
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
        run: |
          set -euo pipefail

          if [ -n "${MERGE_SHA:-}" ] && [ "$MERGE_SHA" != "null" ]; then
            SHA="$MERGE_SHA"
          else
            SHA=$(git rev-parse HEAD)
          fi

          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

      - name: Configure git user
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create git tags (per-project)
        if: steps.to_publish.outputs.projects != ''
        shell: bash
        run: |
          set -euo pipefail

          TARGET_SHA="${{ steps.release_sha.outputs.sha }}"
          PROJECTS="${{ steps.to_publish.outputs.projects }}"

          git fetch --tags

          # Create per-project tags (independent versioning)
          IFS=',' read -ra LIBS <<< "$PROJECTS"
          for lib in "${LIBS[@]}"; do
            # Read project version from package.json with error handling
            LIB_VERSION=$(./scripts/get-lib-version.sh "$lib")

            PROJECT_TAG="${lib}@${LIB_VERSION}"

            if git rev-parse "$PROJECT_TAG" >/dev/null 2>&1; then
              echo "Tag $PROJECT_TAG already exists."
            else
              echo "Creating project tag $PROJECT_TAG at $TARGET_SHA"
              git tag -a "$PROJECT_TAG" "$TARGET_SHA" -m "Release $PROJECT_TAG"
              git push origin "$PROJECT_TAG"
            fi
          done

      - name: Build packages
        if: steps.to_publish.outputs.projects != ''
        run: yarn nx run-many --targets=build --projects="${{ steps.to_publish.outputs.projects }}" --parallel

      - name: Publish to npm via Nx Release
        if: steps.to_publish.outputs.projects != ''
        shell: bash
        run: |
          set -euo pipefail
          echo "Publishing selected projects via Nx Release..."
          npx nx release publish --projects="${{ steps.to_publish.outputs.projects }}"

      - name: Create GitHub Releases (per-project)
        if: steps.to_publish.outputs.projects != ''
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          PROJECTS="${{ steps.to_publish.outputs.projects }}"

          IFS=',' read -ra LIBS <<< "$PROJECTS"
          for lib in "${LIBS[@]}"; do
            if [ -f "libs/$lib/package.json" ]; then
              LIB_VERSION=$(./scripts/get-lib-version.sh "$lib")
              TAG_NAME="${lib}@${LIB_VERSION}"

              echo "Creating GitHub Release for $TAG_NAME..."

              # Extract changelog entry for this version
              CHANGELOG_PATH="libs/$lib/CHANGELOG.md"
              CHANGELOG_ENTRY=""
              if [ -f "$CHANGELOG_PATH" ]; then
                # Extract content between ## [version] and next ## [
                CHANGELOG_ENTRY=$(node -e "
                  const fs = require('fs');
                  const content = fs.readFileSync('$CHANGELOG_PATH', 'utf8');
                  const version = '$LIB_VERSION';
                  const pattern = new RegExp('## \\\\[' + version.replace(/\\./g, '\\\\.') + '\\\\][^\\n]*\\n([\\\\s\\\\S]*?)(?=\\n## \\\\[|$)');
                  const match = content.match(pattern);
                  if (match) {
                    console.log(match[1].trim());
                  }
                " 2>/dev/null || echo "")
              fi

              # Build release body
              BODY="## ${lib} v${LIB_VERSION}"
              BODY+=$'\n\n'
              BODY+="ðŸ“¦ **npm:** [\`${lib}@${LIB_VERSION}\`](https://www.npmjs.com/package/${lib}/v/${LIB_VERSION})"

              if [ -n "$CHANGELOG_ENTRY" ]; then
                BODY+=$'\n\n---\n\n'
                BODY+="$CHANGELOG_ENTRY"
              fi

              # Create release using gh CLI (check if exists first)
              if gh release view "$TAG_NAME" >/dev/null 2>&1; then
                echo "Release $TAG_NAME already exists, skipping..."
              else
                gh release create "$TAG_NAME" \
                  --title "$TAG_NAME" \
                  --notes "$BODY"
              fi
            fi
          done

      - name: Summary
        if: steps.to_publish.outputs.projects != ''
        shell: bash
        run: |
          set -euo pipefail

          echo "## Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Published projects:** ${{ steps.to_publish.outputs.projects }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release commit:** ${{ steps.release_sha.outputs.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Tags" >> $GITHUB_STEP_SUMMARY
          IFS=',' read -ra LIBS <<< "${{ steps.to_publish.outputs.projects }}"
          for lib in "${LIBS[@]}"; do
            if [ -f "libs/$lib/package.json" ]; then
              LIB_VERSION=$(./scripts/get-lib-version.sh "$lib")
              echo "- ${lib}@${LIB_VERSION}" >> $GITHUB_STEP_SUMMARY
            fi
          done
