---
title: 'ast-guard'
description: 'Production-ready AST security guard for JavaScript validation'
---

# ast-guard

Production-ready AST security guard for JavaScript validation and code safety. Blocks all known vm2/isolated-vm/node-vm CVE exploits.

## Installation

```bash
npm install ast-guard
```

## Quick Start

```typescript
import { validate, PRESETS } from 'ast-guard';

const result = validate('const x = 1 + 2;', PRESETS.SECURE);
console.log(result.valid); // true
```

## Features

- **100% CVE Coverage**: Blocks all known vm2, isolated-vm, and node-vm exploits
- **613+ Security Tests**: Comprehensive test suite with 95%+ code coverage
- **Security Presets**: STRICT, SECURE, STANDARD, PERMISSIVE
- **Zero Dependencies**: Only uses acorn for parsing

## AgentScript preset hardening

Use `createAgentScriptPreset()` when you want AST validation to match Enclave's runtime sandbox. The preset now:

- Blocks modern browser primitives like `structuredClone`, `AbortController`/`AbortSignal`, `MessageChannel`/`MessagePort`, `BroadcastChannel`, `TextEncoder`/`TextDecoder`, and `Intl` so those capabilities never reach execution.
- Treats `queueMicrotask` the same way as timers to guard against microtask flooding attacks.
- Reports dynamic `import()` expressions through `NoEvalRule`, preventing untrusted code from lazy-loading modules.

## Security Presets

| Preset | Description |
|--------|-------------|
| `STRICT` | Maximum security, minimal features |
| `SECURE` | Balanced security for most use cases |
| `STANDARD` | Standard security with more features |
| `PERMISSIVE` | Minimal restrictions |

## API

### `validate(code, preset)`

Validates JavaScript code against a security preset.

```typescript
import { validate, PRESETS } from 'ast-guard';

const result = validate(code, PRESETS.SECURE);

if (result.valid) {
  // Code is safe to execute
} else {
  console.log(result.errors);
}
```

### `transform(code, options)`

Transforms code to add safety features like loop guards.

```typescript
import { transform } from 'ast-guard';

const transformed = transform(code, {
  maxIterations: 10000,
  maxDepth: 100
});

// Template literal transforms automatically leave tagged templates untouched
// so tag functions continue receiving the original raw strings.
```

## Built-in Rules

### ResourceExhaustionRule

Detects AST patterns that could cause CPU or memory exhaustion by exploiting native code execution paths that bypass VM timeout.

**Detected Patterns:**
- BigInt exponentiation with large exponents: `2n ** 1000000n`
- Large array allocations: `new Array(10000000)`
- String repeat with large counts: `'x'.repeat(10000000)`
- Constructor property access chains (sandbox escape vector)
- String concatenation building `'constructor'` (obfuscation attempt)

**Configuration Options:**

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `maxBigIntExponent` | number | 10000 | Maximum allowed BigInt exponent |
| `maxArraySize` | number | 1000000 | Maximum allowed array size literal |
| `maxStringRepeat` | number | 100000 | Maximum allowed string repeat count |
| `blockConstructorAccess` | boolean | true | Block constructor property access patterns |
| `blockBigIntExponentiation` | boolean | false | Block all BigInt exponentiation |

**Example Usage:**

```typescript
import { validate, ResourceExhaustionRule } from 'ast-guard';

const rules = [
  new ResourceExhaustionRule({
    maxBigIntExponent: 5000,
    maxArraySize: 500000,
    blockConstructorAccess: true,
  }),
];

const result = validate(code, { rules });
```

**Blocked Attack Examples:**

```javascript
// CPU exhaustion - blocked
2n ** 1000000n

// Memory exhaustion - blocked
new Array(10000000).fill(0)
'x'.repeat(50000000)

// Sandbox escape attempts - blocked
const c = 'con' + 'structor';
obj[c]  // Detected as constructor obfuscation
obj['con' + 'struc' + 'tor']  // Inline concatenation blocked
```

## Links

- [GitHub](https://github.com/agentfront/enclave/tree/main/libs/ast-guard)
- [npm](https://www.npmjs.com/package/ast-guard)
