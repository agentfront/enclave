---
title: 'enclave-vm'
description: 'Secure AgentScript execution environment with defense-in-depth'
---

# enclave-vm

Secure AgentScript execution environment with defense-in-depth architecture for running LLM-generated JavaScript safely.

## Installation

```bash
npm install enclave
```

## Quick Start

```typescript
import { Enclave } from 'enclave-vm';

const enclave = new Enclave({ securityLevel: 'SECURE' });

const result = await enclave.execute(`
  const sum = 1 + 2;
  return sum;
`);

console.log(result.value); // 3
```

## Features

- **Bank-grade Security**: 516+ security tests, 81+ blocked attack vectors
- **Defense-in-depth**: 6 security layers
- **Worker Pool Adapter**: Isolated execution in separate processes
- **Reference Sidecar**: Sandboxed environments for untrusted code

## Security Levels

| Level | Description |
|-------|-------------|
| `STRICT` | Maximum security, minimal features |
| `SECURE` | Balanced security for most use cases |
| `STANDARD` | Standard security with more features |
| `PERMISSIVE` | Minimal restrictions |

## Defense Layers

1. **AST Validation** - Static analysis of code structure
2. **Pre-scanner** - Pattern-based threat detection
3. **Runtime Proxy** - Intercepts dangerous operations
4. **Globals Validation** - Restricts global access
5. **Value Sanitization** - Cleans return values
6. **Timeout/Memory Limits** - Resource constraints
7. **Double VM Layer** - Nested VM isolation (new)

## Double VM Layer

The Double VM layer provides enhanced security through nested VM isolation:

- **Parent VM**: Security barrier with operation validation
- **Inner VM**: Isolated execution environment for user code
- **Tool call flow**: Inner VM → Parent VM validation → Host handler

```typescript
const enclave = new Enclave({
  securityLevel: 'SECURE',
  doubleVm: {
    enabled: true, // Default: true
    parentTimeoutBuffer: 1000, // Extra timeout for parent VM (ms)
    parentValidation: {
      validateOperationNames: true,
      allowedOperationPattern: /^[a-z]+:[a-z]+$/i, // Optional whitelist
      blockedOperationPatterns: [/^admin:/i], // Blacklist patterns
      maxOperationsPerSecond: 100, // Rate limiting
      blockSuspiciousSequences: true, // Detect attack patterns
    },
  },
});
```

### Built-in Suspicious Pattern Detection

| Pattern | Description |
|---------|-------------|
| `EXFIL_LIST_SEND` | List/query followed by send/export |
| `RAPID_ENUMERATION` | Same operation called >10 times in 5s |
| `CREDENTIAL_EXFIL` | Credential access + external operation |
| `BULK_OPERATION` | Bulk/batch/mass operation names |
| `DELETE_AFTER_ACCESS` | Delete operation after data access |

### Custom Patterns

```typescript
const enclave = new Enclave({
  doubleVm: {
    parentValidation: {
      suspiciousPatterns: [
        {
          id: 'CUSTOM_PATTERN',
          description: 'Custom detection logic',
          detect: (operationName, args, history) => {
            // Return true if suspicious
            return operationName.includes('dangerous');
          },
        },
      ],
    },
  },
});
```

## API

### `execute(code, options)`

Execute JavaScript code in a secure environment.

```typescript
const result = await enclave.execute(code, {
  timeout: 5000,
  maxMemory: 128 * 1024 * 1024
});

if (result.success) {
  console.log(result.value);
} else {
  console.log(result.error);
}
```

### `dispose()`

Clean up resources.

```typescript
enclave.dispose();
```

## Reference Sidecar

For handling large data efficiently without bloating the VM context:

```typescript
import {
  REF_ID_PREFIX,  // '__REF_'
  REF_ID_SUFFIX,  // '__'
  isReferenceId,
  REFERENCE_CONFIGS
} from 'enclave-vm';

// Reference IDs follow format: __REF_[UUIDv4]__
const isRef = isReferenceId('__REF_12345678-1234-1234-1234-123456789abc__'); // true

// Get config for security level
const strictConfig = REFERENCE_CONFIGS['STRICT'];
// strictConfig.maxTotalSize = 16MB, maxReferenceSize = 4MB, etc.
```

## Secure Proxy

Runtime property access protection with configurable blocking:

```typescript
import {
  BlockedPropertyCategory,  // 'CONSTRUCTOR' | 'PROTOTYPE' | 'LEGACY_ACCESSOR' | ...
  BLOCKED_PROPERTY_CATEGORIES,
  createSecureProxy
} from 'enclave-vm';

// Available categories: CONSTRUCTOR, PROTOTYPE, LEGACY_ACCESSOR, DUNDER_PROTO, TIMING
const allBlockedProps = BLOCKED_PROPERTY_CATEGORIES.CONSTRUCTOR;
// Set { 'constructor' }
```

## Worker Pool Adapter

For complete process isolation:

```typescript
import { Enclave, WorkerPoolAdapter } from 'enclave-vm';

const enclave = new Enclave({
  securityLevel: 'SECURE',
  adapter: new WorkerPoolAdapter({ poolSize: 4 })
});
```

## Local LLM Scoring

Leverage the Local LLM scorer to gate executions with on-disk models.

**Note:** `LocalLlmScorer` loads the optional `@huggingface/transformers` peer dependency on demand. Install it before enabling local scoring:

```bash
npm install @huggingface/transformers
```

```typescript
import { LocalLlmScorer } from 'enclave-vm/scoring';

const scorer = new LocalLlmScorer({
  modelId: 'Xenova/codebert-base',
  mode: 'classification',
  cacheDir: '~/.enclave/models'
});
```

### `LocalLlmConfig`

- `modelId` (required): Hugging Face identifier such as `Xenova/codebert-base`
- `mode` (optional): `'classification'` (default) or `'similarity'`
- `cacheDir` (optional): Directory for cached models, default `~/.enclave/models`
- `vectoriaConfig` (optional): VectoriaDB settings required when `mode` is `'similarity'`

## Links

- [GitHub](https://github.com/agentfront/enclave/tree/main/libs/enclave)
- [npm](https://www.npmjs.com/package/enclave-vm)
